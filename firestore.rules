rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthed() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userOrgIds() {
      return userDoc().data.orgIds;
    }

    function isMember(orgId) {
      return isAuthed() && userOrgIds().hasAny([orgId]);
    }

    function isAdmin(orgId) {
      return isMember(orgId) &&
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid)).data.role == 'admin';
    }

    // USERS
    match /users/{uid} {
      allow read: if isAuthed() && request.auth.uid == uid;
      allow write: if isAuthed() && request.auth.uid == uid;
    }

    // ORGANIZATIONS TREE
    match /organizations/{orgId} {
      allow read:  if isMember(orgId);
      allow write: if isAdmin(orgId);

      match /members/{uid} {
        allow read:  if isMember(orgId);
        allow write: if isAdmin(orgId);
      }

      match /teams/{teamId} {
        allow read:  if isMember(orgId);
        allow write: if isAdmin(orgId);
      }

      match /settings/{docId} {
        allow read:  if isMember(orgId);
        allow write: if isAdmin(orgId);
      }

      match /payments/{invoiceId} {
        allow read:  if isAdmin(orgId);
        allow write: if isAdmin(orgId);
      }

      match /adAccounts/{adAccountId} {
        allow read:  if isMember(orgId);
        allow write: if isAdmin(orgId);

        match /insightsDaily/{dateId} {
          allow read:  if isMember(orgId);
          allow write: if isAdmin(orgId);
        }

        match /campaigns/{campaignId} {
          allow read:  if isMember(orgId);
          allow write: if isAdmin(orgId);

          match /insightsDaily/{dateId} {
            allow read:  if isMember(orgId);
            allow write: if isAdmin(orgId);
          }
        }

        match /creatives/{creativeId} {
          allow read:  if isMember(orgId);
          allow write: if isAdmin(orgId);
        }

        match /revenues/{revId} {
          allow read:  if isMember(orgId);
          allow write: if isAdmin(orgId);
        }
        
        // PROSPECTS (pour AIDs)
        match /prospects/{prospectId} {
          allow read:  if isMember(orgId);
          allow write: if isAdmin(orgId);
        }
      }
    }
    
    // Temporary backward compatibility - will be removed after migration
    match /aids_prospects/{document=**} {
      allow read, write: if isAuthed();
    }
  }
}